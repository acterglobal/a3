<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="An implementation of the Olm double ratchet."><title>vodozemac::olm - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-b1a3e7f8283b8434.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="vodozemac" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.0-nightly (d5fd09972 2024-01-22)" data-channel="nightly" data-search-js="search-dd67cee4cfa65049.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-f2adc0d6ca4d09fb.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-48f368f3872407c8.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-04d5337699b92874.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../vodozemac/index.html">vodozemac</a><span class="version">0.5.0</span></h2></div><h2 class="location"><a href="#">Module olm</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section><h2><a href="../index.html">In crate vodozemac</a></h2></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../../vodozemac/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">vodozemac</a>::<wbr><a class="mod" href="#">olm</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../src/vodozemac/olm/mod.rs.html#16-114">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>An implementation of the Olm double ratchet.</p>
<h3 id="overview"><a class="doc-anchor" href="#overview">§</a>Overview</h3>
<p>The core component of the crate is the <code>Account</code>, representing a single Olm
participant. An Olm <code>Account</code> consists of a collection of key pairs, though
often documentation will shorten this to just “keys”. These are:</p>
<ol>
<li>An Ed25519 <em>signing key pair</em> representing the stable cryptographic
identity of the participant (the participant’s “fingerprint”).</li>
<li>A Curve25519 <em>sender key pair</em> (also sometimes called the <em>identity key
pair</em>, somewhat confusingly).</li>
<li>A number of one-time key pairs.</li>
<li>A current and previous (if any) “fallback” key pair.</li>
</ol>
<p>While the key in 1 is used for signing but not encryption, the keys in 2-4
participate in a triple Diffie-Hellman key exchange (3DH) with another Olm
participant, thereby establishing an Olm session on each side of the
communication channel. Ultimately, this session is used for deriving the
concrete encryption keys for a particular message.</p>
<p>Olm sessions are represented by the <code>Session</code> struct. Such a session is
created by calling <code>Account::create_outbound_session</code> on one of the
participating accounts, passing it the Curve25519 sender key and one
Curve25519 one-time key of the other side. The protocol is asynchronous, so
the participant can start sending messages to the other side even before the
other side has created a session, producing so-called pre-key messages (see
<code>PreKeyMessage</code>).</p>
<p>Once the other participant receives such a pre-key message, they can create
their own matching session by calling <code>Account::create_inbound_session</code> and
passing it the pre-key message they received and the Curve25519 sender key
of the other side. This completes the establishment of the Olm communication
channel.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>anyhow::Result;
<span class="kw">use </span>vodozemac::olm::{Account, InboundCreationResult, OlmMessage, SessionConfig};

<span class="kw">fn </span>main() -&gt; <span class="prelude-ty">Result</span>&lt;()&gt; {
    <span class="kw">let </span>alice = Account::new();
    <span class="kw">let </span><span class="kw-2">mut </span>bob = Account::new();

    bob.generate_one_time_keys(<span class="number">1</span>);
    <span class="kw">let </span>bob_otk = <span class="kw-2">*</span>bob.one_time_keys().values().next().unwrap();

    <span class="kw">let </span><span class="kw-2">mut </span>alice_session = alice
        .create_outbound_session(SessionConfig::version_2(), bob.curve25519_key(), bob_otk);

    bob.mark_keys_as_published();

    <span class="kw">let </span>message = <span class="string">"Keep it between us, OK?"</span>;
    <span class="kw">let </span>alice_msg = alice_session.encrypt(message);

    <span class="kw">if let </span>OlmMessage::PreKey(m) = alice_msg.clone() {
        <span class="kw">let </span>result = bob.create_inbound_session(alice.curve25519_key(), <span class="kw-2">&amp;</span>m)<span class="question-mark">?</span>;

        <span class="kw">let </span><span class="kw-2">mut </span>bob_session = result.session;
        <span class="kw">let </span>what_bob_received = result.plaintext;

        <span class="macro">assert_eq!</span>(alice_session.session_id(), bob_session.session_id());

        <span class="macro">assert_eq!</span>(message.as_bytes(), what_bob_received);

        <span class="kw">let </span>bob_reply = <span class="string">"Yes. Take this, it's dangerous out there!"</span>;
        <span class="kw">let </span>bob_encrypted_reply = bob_session.encrypt(bob_reply).into();

        <span class="kw">let </span>what_alice_received = alice_session
            .decrypt(<span class="kw-2">&amp;</span>bob_encrypted_reply)<span class="question-mark">?</span>;
        <span class="macro">assert_eq!</span>(what_alice_received, bob_reply.as_bytes());
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div>
<h3 id="sending-messages"><a class="doc-anchor" href="#sending-messages">§</a>Sending messages</h3>
<p>To encrypt a message, just call <code>Session::encrypt(msg_content)</code>. This will
either produce an <code>OlmMessage::PreKey(..)</code> or <code>OlmMessage::Normal(..)</code>
depending on whether the session is fully established. A session is fully
established once you receive (and decrypt) at least one message from the
other side.</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Account.html" title="struct vodozemac::olm::Account">Account</a></div><div class="desc docblock-short">An Olm account manages all cryptographic keys used on a device.</div></li><li><div class="item-name"><a class="struct" href="struct.AccountPickle.html" title="struct vodozemac::olm::AccountPickle">AccountPickle</a></div><div class="desc docblock-short">A format suitable for serialization which implements <a href="../../serde/ser/trait.Serialize.html" title="trait serde::ser::Serialize"><code>serde::Serialize</code></a>
and <a href="../../serde/de/trait.Deserialize.html" title="trait serde::de::Deserialize"><code>serde::Deserialize</code></a>. Obtainable by calling <a href="struct.Account.html#method.pickle" title="method vodozemac::olm::Account::pickle"><code>Account::pickle</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.IdentityKeys.html" title="struct vodozemac::olm::IdentityKeys">IdentityKeys</a></div><div class="desc docblock-short">Struct holding the two public identity keys of an <a href="struct.Account.html" title="struct vodozemac::olm::Account"><code>Account</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.InboundCreationResult.html" title="struct vodozemac::olm::InboundCreationResult">InboundCreationResult</a></div><div class="desc docblock-short">Return type for the creation of inbound <a href="struct.Session.html" title="struct vodozemac::olm::Session"><code>Session</code></a> objects.</div></li><li><div class="item-name"><a class="struct" href="struct.Message.html" title="struct vodozemac::olm::Message">Message</a></div><div class="desc docblock-short">An encrypted Olm message.</div></li><li><div class="item-name"><a class="struct" href="struct.OneTimeKeyGenerationResult.html" title="struct vodozemac::olm::OneTimeKeyGenerationResult">OneTimeKeyGenerationResult</a></div><div class="desc docblock-short">The result type for the one-time key generation operation.</div></li><li><div class="item-name"><a class="struct" href="struct.PreKeyMessage.html" title="struct vodozemac::olm::PreKeyMessage">PreKeyMessage</a></div><div class="desc docblock-short">An encrypted Olm pre-key message.</div></li><li><div class="item-name"><a class="struct" href="struct.RatchetPublicKey.html" title="struct vodozemac::olm::RatchetPublicKey">RatchetPublicKey</a></div></li><li><div class="item-name"><a class="struct" href="struct.Session.html" title="struct vodozemac::olm::Session">Session</a></div><div class="desc docblock-short">An Olm session represents one end of an encrypted communication channel
between two participants.</div></li><li><div class="item-name"><a class="struct" href="struct.SessionConfig.html" title="struct vodozemac::olm::SessionConfig">SessionConfig</a></div><div class="desc docblock-short">A struct to configure how Olm sessions should work under the hood.
Currently only the MAC truncation behaviour can be configured.</div></li><li><div class="item-name"><a class="struct" href="struct.SessionKeys.html" title="struct vodozemac::olm::SessionKeys">SessionKeys</a></div><div class="desc docblock-short">The set of keys that were used to establish the Olm Session,</div></li><li><div class="item-name"><a class="struct" href="struct.SessionPickle.html" title="struct vodozemac::olm::SessionPickle">SessionPickle</a></div><div class="desc docblock-short">A format suitable for serialization which implements <a href="../../serde/ser/trait.Serialize.html" title="trait serde::ser::Serialize"><code>serde::Serialize</code></a>
and <a href="../../serde/de/trait.Deserialize.html" title="trait serde::de::Deserialize"><code>serde::Deserialize</code></a>. Obtainable by calling <a href="struct.Session.html#method.pickle" title="method vodozemac::olm::Session::pickle"><code>Session::pickle</code></a>.</div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.DecryptionError.html" title="enum vodozemac::olm::DecryptionError">DecryptionError</a></div><div class="desc docblock-short">Error type for Olm-based decryption failures.</div></li><li><div class="item-name"><a class="enum" href="enum.MessageType.html" title="enum vodozemac::olm::MessageType">MessageType</a></div><div class="desc docblock-short">An enum over the two supported message types.</div></li><li><div class="item-name"><a class="enum" href="enum.OlmMessage.html" title="enum vodozemac::olm::OlmMessage">OlmMessage</a></div><div class="desc docblock-short">Enum over the different Olm message types.</div></li><li><div class="item-name"><a class="enum" href="enum.SessionCreationError.html" title="enum vodozemac::olm::SessionCreationError">SessionCreationError</a></div><div class="desc docblock-short">Error describing failure modes when creating a Olm Session from an incoming
Olm message.</div></li></ul></section></div></main></body></html>